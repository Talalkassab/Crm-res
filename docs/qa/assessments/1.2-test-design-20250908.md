# Test Design: Story 1.2

Date: 2025-09-08
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 15
- Unit tests: 11 (73%)
- Integration tests: 9 (60%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 8, P1: 6, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1: WhatsApp Cloud API webhook endpoint receives and verifies incoming messages with signature validation

#### Scenarios

| ID           | Level       | Priority | Test                              | Justification                    |
| ------------ | ----------- | -------- | --------------------------------- | -------------------------------- |
| 1.2-UNIT-001 | Unit        | P0       | Valid HMAC signature validation   | Security-critical pure logic     |
| 1.2-UNIT-002 | Unit        | P0       | Invalid HMAC signature rejection  | Security validation logic        |
| 1.2-UNIT-003 | Unit        | P0       | Missing signature handling        | Security edge case validation    |
| 1.2-INT-001  | Integration | P0       | Webhook endpoint signature flow   | Critical security endpoint       |

### AC2: Message queue (BullMQ) processes incoming messages asynchronously with retry logic

#### Scenarios

| ID           | Level       | Priority | Test                              | Justification                    |
| ------------ | ----------- | -------- | --------------------------------- | -------------------------------- |
| 1.2-UNIT-004 | Unit        | P1       | Queue message processing logic    | Core business logic              |
| 1.2-UNIT-005 | Unit        | P1       | Retry mechanism with backoff      | Algorithm correctness            |
| 1.2-INT-002  | Integration | P1       | Redis queue integration           | Component interaction            |
| 1.2-INT-003  | Integration | P1       | Dead letter queue handling        | Error recovery flow              |

### AC3: Basic echo response confirms message receipt (temporary, replaced by AI in next story)

#### Scenarios

| ID           | Level       | Priority | Test                              | Justification                    |
| ------------ | ----------- | -------- | --------------------------------- | -------------------------------- |
| 1.2-UNIT-006 | Unit        | P1       | Response formatting for text      | Message formatting logic         |
| 1.2-UNIT-007 | Unit        | P1       | Response formatting for media     | Complex formatting logic         |
| 1.2-INT-004  | Integration | P1       | Complete webhook to echo flow     | End-to-end message processing    |

### AC4: Outbound message sending works with template messages for feedback requests

#### Scenarios

| ID           | Level       | Priority | Test                              | Justification                    |
| ------------ | ----------- | -------- | --------------------------------- | -------------------------------- |
| 1.2-UNIT-008 | Unit        | P1       | Template message formatting       | Template logic validation        |
| 1.2-UNIT-009 | Unit        | P1       | API client error handling         | Error handling logic             |
| 1.2-INT-005  | Integration | P1       | WhatsApp API integration          | External API interaction         |

### AC5: Phone number provisioning process documented for restaurant onboarding

#### Scenarios

| ID           | Level       | Priority | Test                              | Justification                    |
| ------------ | ----------- | -------- | --------------------------------- | -------------------------------- |
| 1.2-UNIT-010 | Unit        | P2       | Documentation completeness check  | Admin process validation         |

### AC6: Rate limiting implemented to stay within WhatsApp's 80 messages/second limit

#### Scenarios

| ID           | Level       | Priority | Test                              | Justification                    |
| ------------ | ----------- | -------- | --------------------------------- | -------------------------------- |
| 1.2-UNIT-011 | Unit        | P0       | Rate limit algorithm validation   | Compliance-critical logic        |
| 1.2-UNIT-012 | Unit        | P0       | Sliding window rate calculation   | Complex algorithm correctness    |
| 1.2-INT-006  | Integration | P0       | Redis-backed rate limiter         | Critical system component        |
| 1.2-INT-007  | Integration | P0       | Rate limit middleware enforcement | Request processing flow          |

### AC7: Webhook processes message status updates (sent, delivered, read) for analytics

#### Scenarios

| ID           | Level       | Priority | Test                              | Justification                    |
| ------------ | ----------- | -------- | --------------------------------- | -------------------------------- |
| 1.2-UNIT-013 | Unit        | P1       | Status update parsing logic       | Data transformation logic        |
| 1.2-INT-008  | Integration | P1       | Status callback processing flow   | Analytics data pipeline          |

### AC8: Error handling gracefully manages API failures with exponential backoff

#### Scenarios

| ID           | Level       | Priority | Test                              | Justification                    |
| ------------ | ----------- | -------- | --------------------------------- | -------------------------------- |
| 1.2-UNIT-014 | Unit        | P0       | Exponential backoff calculation   | Critical reliability algorithm   |
| 1.2-UNIT-015 | Unit        | P0       | Circuit breaker state transitions | System stability logic           |
| 1.2-INT-009  | Integration | P0       | API failure handling with retry   | External system resilience       |

## Risk Coverage

This test design covers the following critical risks:

- **SECURITY-001**: Unauthorized webhook access - Covered by signature validation tests (1.2-UNIT-001-003, 1.2-INT-001)
- **COMPLIANCE-001**: WhatsApp rate limit violations - Covered by rate limiting tests (1.2-UNIT-011-012, 1.2-INT-006-007)
- **RELIABILITY-001**: Service degradation under load - Covered by error handling and queue processing tests (1.2-UNIT-014-015, 1.2-INT-009)
- **INTEGRATION-001**: WhatsApp API communication failures - Covered by API client and retry logic tests (1.2-UNIT-009, 1.2-INT-005)

## Recommended Execution Order

1. **P0 Unit tests (fail fast)**
   - 1.2-UNIT-001: Valid HMAC signature validation
   - 1.2-UNIT-002: Invalid HMAC signature rejection
   - 1.2-UNIT-003: Missing signature handling
   - 1.2-UNIT-011: Rate limit algorithm validation
   - 1.2-UNIT-012: Sliding window rate calculation
   - 1.2-UNIT-014: Exponential backoff calculation
   - 1.2-UNIT-015: Circuit breaker state transitions

2. **P0 Integration tests**
   - 1.2-INT-001: Webhook endpoint signature verification flow
   - 1.2-INT-006: Redis-backed rate limiter integration
   - 1.2-INT-007: Rate limit middleware enforcement
   - 1.2-INT-009: API failure handling with retry

3. **P1 Unit tests**
   - 1.2-UNIT-004: Queue message processing logic
   - 1.2-UNIT-005: Retry mechanism with exponential backoff
   - 1.2-UNIT-006: Response formatting for text messages
   - 1.2-UNIT-007: Response formatting for media messages
   - 1.2-UNIT-008: Template message formatting
   - 1.2-UNIT-009: API client error handling
   - 1.2-UNIT-013: Status update parsing logic

4. **P1 Integration tests**
   - 1.2-INT-002: Redis queue integration with Celery
   - 1.2-INT-003: Dead letter queue handling
   - 1.2-INT-004: Complete webhook to echo response flow
   - 1.2-INT-005: WhatsApp API integration with retry logic
   - 1.2-INT-008: Status callback processing flow

5. **P2 tests as time permits**
   - 1.2-UNIT-010: Documentation completeness validation

## Test Environment Requirements

### Unit Tests
- Python 3.12+ with pytest
- Mock objects for external dependencies
- No external service dependencies

### Integration Tests
- Redis instance for queue and rate limiting
- Test database (PostgreSQL)
- Mock WhatsApp API endpoints
- Celery worker processes

## Quality Checklist Verification

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent

## Implementation Notes

### Security Testing Focus
Given the WhatsApp Business API integration involves webhook security and rate limiting compliance, special attention must be paid to:
- HMAC signature validation edge cases
- Replay attack prevention
- Rate limiting accuracy under various load patterns

### Performance Considerations
- Rate limiting tests should validate both 80 msg/sec (business) and 1000 msg/sec (user-initiated) limits
- Queue processing tests should handle burst scenarios
- Error handling tests should verify no memory leaks during retry cycles

### Maintenance Guidelines
- Mock WhatsApp API responses should be updated when API versions change
- Rate limiting thresholds should be configurable for different environments
- Test data should include realistic message payloads and edge cases