# Story 1.2: WhatsApp Business API Integration

## Status
Draft

## Story

**As a** restaurant owner,  
**I want** my restaurant connected to WhatsApp Business API,  
**So that** I can automatically receive and respond to customer messages.

## Acceptance Criteria

1. WhatsApp Cloud API webhook endpoint receives and verifies incoming messages with signature validation
2. Message queue (BullMQ) processes incoming messages asynchronously with retry logic
3. Basic echo response confirms message receipt (temporary, replaced by AI in next story)
4. Outbound message sending works with template messages for feedback requests
5. Phone number provisioning process documented for restaurant onboarding
6. Rate limiting implemented to stay within WhatsApp's 80 messages/second limit
7. Webhook processes message status updates (sent, delivered, read) for analytics
8. Error handling gracefully manages API failures with exponential backoff

## Tasks / Subtasks

- [ ] Create WhatsApp Gateway Service Structure (AC: 1)
  - [ ] Initialize services/whatsapp-gateway with FastAPI structure according to unified-project-structure.md
  - [ ] Create src/api/, src/handlers/, src/services/, src/models/, src/utils/ directories
  - [ ] Set up main.py with FastAPI app initialization and health endpoint
  - [ ] Configure Dockerfile following backend-architecture.md multi-stage build pattern

- [ ] Implement Webhook Endpoint with Signature Validation (AC: 1)
  - [ ] Create webhook route at POST /webhook for incoming messages
  - [ ] Implement Meta signature validation using sha256 HMAC verification
  - [ ] Handle webhook verification GET requests for initial setup
  - [ ] Create Pydantic models for WhatsApp message structure in src/models/

- [ ] Set up Message Queue Processing (AC: 2)
  - [ ] Install and configure BullMQ for asynchronous message processing
  - [ ] Create message processor service with retry logic (3 attempts with exponential backoff)
  - [ ] Implement queue health monitoring and dead letter queue handling
  - [ ] Add queue metrics endpoint for monitoring

- [ ] Create Basic Echo Response System (AC: 3)
  - [ ] Implement temporary echo handler in src/handlers/echo.py
  - [ ] Format responses to confirm message receipt with timestamp
  - [ ] Handle different message types (text, media, interactive)
  - [ ] Log all interactions for debugging and analytics

- [ ] Implement Outbound Message Sending (AC: 4)
  - [ ] Create WhatsApp API client in src/services/whatsapp_client.py
  - [ ] Implement template message sending for feedback requests
  - [ ] Handle message status callbacks and update database
  - [ ] Add retry mechanism for failed sends

- [ ] Add Rate Limiting Implementation (AC: 6)
  - [ ] Implement rate limiting middleware using Redis backing store
  - [ ] Configure 80 messages/second limit for business-initiated messages
  - [ ] Handle 1000 messages/second for user-initiated responses
  - [ ] Add rate limit monitoring and alerting

- [ ] Create Error Handling with Exponential Backoff (AC: 8)
  - [ ] Implement comprehensive error handling for all API failures
  - [ ] Create exponential backoff logic for webhook delivery failures
  - [ ] Add structured logging for all errors with correlation IDs
  - [ ] Implement circuit breaker pattern for external API calls

- [ ] Database Integration and Models (AC: 7)
  - [ ] Create message status tracking in existing conversations table
  - [ ] Update customer last_interaction timestamps on message receipt
  - [ ] Store message delivery status updates for analytics
  - [ ] Implement proper error logging in database

- [ ] Testing Infrastructure (AC: All)
  - [ ] Create unit tests for webhook validation and message processing
  - [ ] Add integration tests for WhatsApp API interaction
  - [ ] Mock WhatsApp API responses for testing
  - [ ] Test rate limiting and error handling scenarios

- [ ] Documentation and Configuration (AC: 5)
  - [ ] Document phone number provisioning process for restaurant onboarding
  - [ ] Create environment variable configuration template
  - [ ] Add API documentation using FastAPI OpenAPI
  - [ ] Create deployment and monitoring guidelines

## Dev Notes

### Previous Story Insights
[Source: Story 1.1 Completion Notes]
- Monorepo foundation successfully established with services directory ready for whatsapp-gateway
- FastAPI services pattern proven with core-api and ai-processor implementations
- Docker multi-stage builds and testing infrastructure already configured
- Supabase database with proper multi-tenant structure available for message storage
- CI/CD pipeline ready for Python services with matrix builds

### Tech Stack Configuration
[Source: architecture/tech-stack.md]

**Core Technologies for WhatsApp Service:**
- Python 3.12+ with FastAPI 0.110+ for webhook handling
- BullMQ with Redis for asynchronous message processing
- WhatsApp Cloud API v19.0 for messaging platform integration
- asyncio + httpx for async HTTP operations
- Pytest 8.0+ for testing framework
- Docker 24+ with multi-stage builds for containerization

**External API Details:**
[Source: architecture/external-apis.md]
- **WhatsApp Cloud API Base URL:** https://graph.facebook.com/v19.0/{phone_number_id}
- **Authentication:** Bearer token (System User Access Token)
- **Rate Limits:** 80 messages/second (business initiated), 1000 messages/second (user initiated)
- **Key Endpoints:** POST /messages, POST /media/{media_id}, GET /phone_numbers
- **Integration Notes:** Webhook verification required on setup, must handle status callbacks

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]

WhatsApp Gateway service must be created at:
```
services/whatsapp-gateway/
├── src/
│   ├── api/               # FastAPI routes
│   ├── handlers/          # Webhook handlers
│   ├── services/          # Business logic
│   ├── models/            # Pydantic models
│   ├── utils/             # Utilities
│   └── main.py            # FastAPI app entry
├── tests/
│   ├── unit/             # Unit tests
│   └── integration/      # API integration tests
├── Dockerfile
└── requirements.txt
```

### Data Models and Database Integration
[Source: architecture/data-models.md, architecture/database-schema.md]

**Relevant Database Tables to Use:**
- **customers table:** Store/update whatsapp_number, last_interaction, conversation_context
- **conversations table:** Track message history in messages JSONB field, update status
- **restaurants table:** Reference whatsapp_number for routing messages

**Message Storage Pattern:**
```python
# Update conversations.messages JSONB array
message_entry = {
    "id": str(uuid.uuid4()),
    "sender": "customer" | "ai" | "staff",
    "content": message_text,
    "timestamp": datetime.utcnow().isoformat(),
    "whatsapp_message_id": wa_message_id,
    "status": "sent" | "delivered" | "read" | "failed"
}
```

### Authentication and Security
[Source: architecture/backend-architecture.md]

**Webhook Security Requirements:**
- Meta signature validation using HMAC SHA-256
- Verify X-Hub-Signature-256 header against webhook secret
- Implement proper environment variable handling (never process.env directly)

**Rate Limiting Implementation:**
- Use Redis-backed rate limiting with sliding window
- Separate limits for business-initiated (80/sec) vs user-initiated (1000/sec)
- Implement circuit breaker for external API failures

### Coding Standards Compliance
[Source: architecture/coding-standards.md]

**Critical Rules for Implementation:**
- Define types in packages/shared-types and import from there
- Never access process.env directly - use config objects
- API routes use kebab-case naming (/webhook, /health)
- Database operations use snake_case (whatsapp_number)
- All API routes must use standard error handler
- Implement proper async/await patterns for all I/O operations

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Backend Testing Standards:**
- Unit tests in services/whatsapp-gateway/tests/unit/
- Integration tests in services/whatsapp-gateway/tests/integration/
- Use conftest.py for pytest configuration
- Test files must follow naming: test_*.py
- Mock external dependencies (WhatsApp API) in unit tests
- Maintain testing pyramid: 35% backend unit tests as target

**Specific Test Coverage Required:**
- Webhook signature validation (valid/invalid scenarios)
- Message queue processing with retry logic
- Rate limiting enforcement
- Error handling and exponential backoff
- Database integration and message storage

### Container Configuration
[Source: architecture/backend-architecture.md]

**Dockerfile Requirements:**
- Multi-stage build pattern (builder + production stages)
- Python 3.12-slim base image
- Non-root user for security (appuser)
- Health check endpoint at /health
- Environment variables for configuration
- Copy requirements.txt and install dependencies in builder stage

### Error Handling and Monitoring
**Structured Logging Required:**
- Correlation IDs for request tracing
- All API failures logged with context
- Message processing status tracking
- Rate limit violations monitoring

**Exponential Backoff Implementation:**
- Initial delay: 1 second
- Maximum delay: 60 seconds
- Maximum attempts: 3
- Jitter to prevent thundering herd

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Unit Test Locations:**
- services/whatsapp-gateway/tests/unit/
- Test webhook validation: test_webhook_validation.py
- Test message processing: test_message_processor.py
- Test WhatsApp API client: test_whatsapp_client.py
- Test rate limiting: test_rate_limiting.py

**Integration Test Requirements:**
- services/whatsapp-gateway/tests/integration/
- Test complete webhook-to-response flow
- Test message queue integration with Redis
- Test database operations and message storage
- Mock external WhatsApp API for testing

**Testing Frameworks:**
- Pytest 8.0+ with async support
- Use fixtures for test data management
- Mock WhatsApp API responses with httpx_mock
- Redis test instance for queue testing

**Coverage Requirements:**
- Minimum 80% code coverage for business logic
- 100% coverage for security-related functions (signature validation)
- Test all error scenarios and edge cases

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results

*This section will be populated by the QA Agent after story completion*