# Story 1.2: WhatsApp Business API Integration

## Status
Done

## Story

**As a** restaurant owner,  
**I want** my restaurant connected to WhatsApp Business API,  
**So that** I can automatically receive and respond to customer messages.

## Acceptance Criteria

1. WhatsApp Cloud API webhook endpoint receives and verifies incoming messages with signature validation
2. Message queue (BullMQ) processes incoming messages asynchronously with retry logic
3. Basic echo response confirms message receipt (temporary, replaced by AI in next story)
4. Outbound message sending works with template messages for feedback requests
5. Phone number provisioning process documented for restaurant onboarding
6. Rate limiting implemented to stay within WhatsApp's 80 messages/second limit
7. Webhook processes message status updates (sent, delivered, read) for analytics
8. Error handling gracefully manages API failures with exponential backoff

## Tasks / Subtasks

- [x] Create WhatsApp Gateway Service Structure (AC: 1)
  - [x] Initialize services/whatsapp-gateway with FastAPI structure according to unified-project-structure.md
  - [x] Create src/api/, src/handlers/, src/services/, src/models/, src/utils/ directories
  - [x] Set up main.py with FastAPI app initialization and health endpoint
  - [x] Configure Dockerfile following backend-architecture.md multi-stage build pattern

- [x] Implement Webhook Endpoint with Signature Validation (AC: 1)
  - [x] Create webhook route at POST /webhook for incoming messages
  - [x] Implement Meta signature validation using sha256 HMAC verification
  - [x] Handle webhook verification GET requests for initial setup
  - [x] Create Pydantic models for WhatsApp message structure in src/models/

- [x] Set up Message Queue Processing (AC: 2)
  - [x] Install and configure Celery with Redis for asynchronous message processing
  - [x] Create message processor service with retry logic (3 attempts with exponential backoff)
  - [x] Implement queue health monitoring and dead letter queue handling
  - [x] Add queue metrics endpoint for monitoring

- [x] Create Basic Echo Response System (AC: 3)
  - [x] Implement temporary echo handler in src/handlers/echo.py
  - [x] Format responses to confirm message receipt with timestamp
  - [x] Handle different message types (text, media, interactive)
  - [x] Log all interactions for debugging and analytics

- [x] Implement Outbound Message Sending (AC: 4)
  - [x] Create WhatsApp API client in src/services/whatsapp_client.py
  - [x] Implement template message sending for feedback requests
  - [x] Handle message status callbacks and update database
  - [x] Add retry mechanism for failed sends

- [x] Add Rate Limiting Implementation (AC: 6)
  - [x] Implement rate limiting middleware using Redis backing store
  - [x] Configure 80 messages/second limit for business-initiated messages
  - [x] Handle 1000 messages/second for user-initiated responses
  - [x] Add rate limit monitoring and alerting

- [x] Create Error Handling with Exponential Backoff (AC: 8)
  - [x] Implement comprehensive error handling for all API failures
  - [x] Create exponential backoff logic for webhook delivery failures
  - [x] Add structured logging for all errors with correlation IDs
  - [x] Implement circuit breaker pattern for external API calls

- [x] Database Integration and Models (AC: 7)
  - [x] Create message status tracking in existing conversations table
  - [x] Update customer last_interaction timestamps on message receipt
  - [x] Store message delivery status updates for analytics
  - [x] Implement proper error logging in database

- [x] Testing Infrastructure (AC: All)
  - [x] Create unit tests for webhook validation and message processing
  - [x] Add integration tests for WhatsApp API interaction
  - [x] Mock WhatsApp API responses for testing
  - [x] Test rate limiting and error handling scenarios

- [x] Documentation and Configuration (AC: 5)
  - [x] Document phone number provisioning process for restaurant onboarding
  - [x] Create environment variable configuration template
  - [x] Add API documentation using FastAPI OpenAPI
  - [x] Create deployment and monitoring guidelines

## Dev Notes

### Previous Story Insights
[Source: Story 1.1 Completion Notes]
- Monorepo foundation successfully established with services directory ready for whatsapp-gateway
- FastAPI services pattern proven with core-api and ai-processor implementations
- Docker multi-stage builds and testing infrastructure already configured
- Supabase database with proper multi-tenant structure available for message storage
- CI/CD pipeline ready for Python services with matrix builds

### Tech Stack Configuration
[Source: architecture/tech-stack.md]

**Core Technologies for WhatsApp Service:**
- Python 3.12+ with FastAPI 0.110+ for webhook handling
- BullMQ with Redis for asynchronous message processing
- WhatsApp Cloud API v19.0 for messaging platform integration
- asyncio + httpx for async HTTP operations
- Pytest 8.0+ for testing framework
- Docker 24+ with multi-stage builds for containerization

**External API Details:**
[Source: architecture/external-apis.md]
- **WhatsApp Cloud API Base URL:** https://graph.facebook.com/v19.0/{phone_number_id}
- **Authentication:** Bearer token (System User Access Token)
- **Rate Limits:** 80 messages/second (business initiated), 1000 messages/second (user initiated)
- **Key Endpoints:** POST /messages, POST /media/{media_id}, GET /phone_numbers
- **Integration Notes:** Webhook verification required on setup, must handle status callbacks

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]

WhatsApp Gateway service must be created at:
```
services/whatsapp-gateway/
├── src/
│   ├── api/               # FastAPI routes
│   ├── handlers/          # Webhook handlers
│   ├── services/          # Business logic
│   ├── models/            # Pydantic models
│   ├── utils/             # Utilities
│   └── main.py            # FastAPI app entry
├── tests/
│   ├── unit/             # Unit tests
│   └── integration/      # API integration tests
├── Dockerfile
└── requirements.txt
```

### Data Models and Database Integration
[Source: architecture/data-models.md, architecture/database-schema.md]

**Relevant Database Tables to Use:**
- **customers table:** Store/update whatsapp_number, last_interaction, conversation_context
- **conversations table:** Track message history in messages JSONB field, update status
- **restaurants table:** Reference whatsapp_number for routing messages

**Message Storage Pattern:**
```python
# Update conversations.messages JSONB array
message_entry = {
    "id": str(uuid.uuid4()),
    "sender": "customer" | "ai" | "staff",
    "content": message_text,
    "timestamp": datetime.utcnow().isoformat(),
    "whatsapp_message_id": wa_message_id,
    "status": "sent" | "delivered" | "read" | "failed"
}
```

### Authentication and Security
[Source: architecture/backend-architecture.md]

**Webhook Security Requirements:**
- Meta signature validation using HMAC SHA-256
- Verify X-Hub-Signature-256 header against webhook secret
- Implement proper environment variable handling (never process.env directly)

**Rate Limiting Implementation:**
- Use Redis-backed rate limiting with sliding window
- Separate limits for business-initiated (80/sec) vs user-initiated (1000/sec)
- Implement circuit breaker for external API failures

### Coding Standards Compliance
[Source: architecture/coding-standards.md]

**Critical Rules for Implementation:**
- Define types in packages/shared-types and import from there
- Never access process.env directly - use config objects
- API routes use kebab-case naming (/webhook, /health)
- Database operations use snake_case (whatsapp_number)
- All API routes must use standard error handler
- Implement proper async/await patterns for all I/O operations

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Backend Testing Standards:**
- Unit tests in services/whatsapp-gateway/tests/unit/
- Integration tests in services/whatsapp-gateway/tests/integration/
- Use conftest.py for pytest configuration
- Test files must follow naming: test_*.py
- Mock external dependencies (WhatsApp API) in unit tests
- Maintain testing pyramid: 35% backend unit tests as target

**Specific Test Coverage Required:**
- Webhook signature validation (valid/invalid scenarios)
- Message queue processing with retry logic
- Rate limiting enforcement
- Error handling and exponential backoff
- Database integration and message storage

### Container Configuration
[Source: architecture/backend-architecture.md]

**Dockerfile Requirements:**
- Multi-stage build pattern (builder + production stages)
- Python 3.12-slim base image
- Non-root user for security (appuser)
- Health check endpoint at /health
- Environment variables for configuration
- Copy requirements.txt and install dependencies in builder stage

### Error Handling and Monitoring
**Structured Logging Required:**
- Correlation IDs for request tracing
- All API failures logged with context
- Message processing status tracking
- Rate limit violations monitoring

**Exponential Backoff Implementation:**
- Initial delay: 1 second
- Maximum delay: 60 seconds
- Maximum attempts: 3
- Jitter to prevent thundering herd

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Unit Test Locations:**
- services/whatsapp-gateway/tests/unit/
- Test webhook validation: test_webhook_validation.py
- Test message processing: test_message_processor.py
- Test WhatsApp API client: test_whatsapp_client.py
- Test rate limiting: test_rate_limiting.py

**Integration Test Requirements:**
- services/whatsapp-gateway/tests/integration/
- Test complete webhook-to-response flow
- Test message queue integration with Redis
- Test database operations and message storage
- Mock external WhatsApp API for testing

**Testing Frameworks:**
- Pytest 8.0+ with async support
- Use fixtures for test data management
- Mock WhatsApp API responses with httpx_mock
- Redis test instance for queue testing

**Coverage Requirements:**
- Minimum 80% code coverage for business logic
- 100% coverage for security-related functions (signature validation)
- Test all error scenarios and edge cases

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- No major blocking issues encountered
- Replaced BullMQ with Celery due to Python compatibility
- Updated requirements.txt for Python 3.9 compatibility

### Completion Notes List
- WhatsApp Gateway service successfully created with full FastAPI structure
- Webhook endpoints implemented with proper signature validation
- Celery queue system configured for asynchronous message processing
- Echo response system working for all message types (text, media, interactive)
- WhatsApp API client with retry mechanisms and circuit breaker
- Rate limiting middleware with Redis backing (80/sec business, 1000/sec user)
- Comprehensive error handling with exponential backoff and structured logging
- Database integration for message tracking and customer interaction updates
- Full test suite with unit and integration tests
- Complete documentation including phone number provisioning guide

### File List
**Source Files:**
- services/whatsapp-gateway/src/main.py
- services/whatsapp-gateway/src/api/webhook.py
- services/whatsapp-gateway/src/api/monitoring.py  
- services/whatsapp-gateway/src/api/rate_limit.py
- services/whatsapp-gateway/src/handlers/echo.py
- services/whatsapp-gateway/src/services/queue.py
- services/whatsapp-gateway/src/services/whatsapp_client.py
- services/whatsapp-gateway/src/services/message_sender.py
- services/whatsapp-gateway/src/services/database.py
- services/whatsapp-gateway/src/models/whatsapp.py
- services/whatsapp-gateway/src/utils/config.py
- services/whatsapp-gateway/src/utils/security.py
- services/whatsapp-gateway/src/utils/error_handler.py
- services/whatsapp-gateway/src/utils/logger.py
- services/whatsapp-gateway/src/middleware/rate_limiter.py

**Test Files:**
- services/whatsapp-gateway/tests/conftest.py
- services/whatsapp-gateway/tests/unit/test_health.py
- services/whatsapp-gateway/tests/unit/test_webhook_validation.py
- services/whatsapp-gateway/tests/unit/test_message_processor.py
- services/whatsapp-gateway/tests/unit/test_rate_limiting.py
- services/whatsapp-gateway/tests/unit/test_whatsapp_client.py
- services/whatsapp-gateway/tests/integration/test_webhook_flow.py

**Configuration Files:**
- services/whatsapp-gateway/Dockerfile
- services/whatsapp-gateway/requirements.txt
- services/whatsapp-gateway/.env.example
- services/whatsapp-gateway/README.md
- services/whatsapp-gateway/deployment.md

## QA Results

### Review Date: 2025-09-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation demonstrates high-quality architecture with comprehensive error handling, proper async patterns, and strong adherence to FastAPI best practices. The service structure follows the unified project structure requirements with clear separation of concerns. The codebase shows mature engineering practices including circuit breakers, exponential backoff, and structured logging with correlation IDs.

Notable strengths include robust webhook signature validation, comprehensive rate limiting implementation, and proper database integration patterns. The message queue processing with Celery provides reliable asynchronous handling with retry mechanisms and dead letter queues.

### Refactoring Performed

- **File**: services/whatsapp-gateway/src/services/whatsapp_client.py
  - **Change**: Enhanced error handling with specific exception types (TimeoutException, ConnectError)
  - **Why**: Original code had generic exception handling that made debugging difficult
  - **How**: Added specific handlers for HTTP timeout and connection errors with structured error details

- **File**: services/whatsapp-gateway/src/utils/config.py
  - **Change**: Added configuration validation and production readiness checks
  - **Why**: Missing environment variables could cause runtime failures without clear error messages
  - **How**: Added validation on startup with warning logs for missing critical configuration

### Compliance Check

- Coding Standards: ✓ (Routes use kebab-case, proper async patterns, structured error handling)
- Project Structure: ✓ (Follows unified structure with src/ organization and proper test separation)
- Testing Strategy: ✓ (Comprehensive unit and integration tests with proper mocking strategies)
- All ACs Met: ✓ (All 8 acceptance criteria fully implemented with proper validation)

### Improvements Checklist

- [x] Enhanced error handling in WhatsApp client for better debugging (services/whatsapp-gateway/src/services/whatsapp_client.py)
- [x] Added configuration validation for production readiness (services/whatsapp-gateway/src/utils/config.py)
- [ ] Consider extracting media handling logic to separate service class
- [ ] Add metric collection for rate limiting performance monitoring
- [ ] Implement webhook event replay mechanism for failed processing

### Security Review

✓ **PASS** - Webhook signature validation properly implemented using HMAC SHA-256. Environment variable handling follows secure patterns through config objects. No sensitive data logging detected. Rate limiting provides proper DoS protection.

### Performance Considerations

✓ **PASS** - Async patterns properly implemented throughout. Rate limiting with Redis backing provides efficient throughput management. Circuit breaker pattern prevents cascade failures. Message queue processing handles load distribution effectively.

### Files Modified During Review

- services/whatsapp-gateway/src/services/whatsapp_client.py (Enhanced error handling)
- services/whatsapp-gateway/src/utils/config.py (Added configuration validation)

### Gate Status

Gate: PASS → docs/qa/gates/1.2-whatsapp-business-api-integration.yml
Risk profile: docs/qa/assessments/1.2-risk-20250908.md
NFR assessment: docs/qa/assessments/1.2-nfr-20250908.md

### Recommended Status

✓ Ready for Done - Implementation meets all requirements with high code quality standards. Minor improvements listed above can be addressed in future iterations.