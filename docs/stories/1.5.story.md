# Story 1.5: Minimal Viable Dashboard

## Status
Approved

## Story

**As a** restaurant owner,  
**I want** to monitor AI conversations and feedback metrics,  
**So that** I can track system performance and customer satisfaction.

## Acceptance Criteria

1. Real-time conversation monitor shows active AI chats with intervention capability
2. Feedback analytics display ratings, sentiment trends, and response rates
3. Message history searchable by customer phone or content
4. AI performance metrics show automation rate and escalation frequency
5. Mobile-responsive design works on phones (primary usage device)
6. Arabic/English toggle for interface language
7. Export functionality for feedback data (CSV format)
8. Configuration panel for basic settings (hours, personality, escalation rules)

## Tasks / Subtasks

- [ ] Create Dashboard Shell and Layout Components (AC: 5, 6)
  - [ ] Implement Next.js App Router layout with Arabic RTL support
  - [ ] Create responsive navigation menu using Shadcn/ui components
  - [ ] Build language toggle component with Arabic/English switching
  - [ ] Integrate Supabase Auth Provider for authentication context
  - [ ] Set up Zustand stores for global state management
  - [ ] Configure mobile-first responsive breakpoints with Tailwind

- [ ] Build Real-Time Conversation Monitor (AC: 1)
  - [ ] Create ConversationList component with filterable conversation display
  - [ ] Implement ConversationView component for message thread display
  - [ ] Build InterventionPanel for manual message sending capability
  - [ ] Set up Supabase Realtime subscriptions for live conversation updates
  - [ ] Create useRealtimeConversations hook for WebSocket management
  - [ ] Implement conversation status indicators (active/escalated/resolved)

- [ ] Implement Feedback Analytics Dashboard (AC: 2)
  - [ ] Build MetricsGrid component displaying KPIs using Shadcn/ui cards
  - [ ] Create SatisfactionChart component with Recharts for rating trends
  - [ ] Implement sentiment analysis visualization with color coding
  - [ ] Build response rate metrics with percentage calculations
  - [ ] Create branch comparison component for multi-location analytics
  - [ ] Set up auto-refresh for analytics data every 30 seconds

- [ ] Create Searchable Message History (AC: 3)
  - [ ] Build SearchInterface component with phone number and content filters
  - [ ] Implement full-text search functionality using Supabase full-text search
  - [ ] Create MessageHistory component with pagination support
  - [ ] Add search result highlighting for found terms
  - [ ] Implement advanced filters (date range, branch, conversation type)
  - [ ] Create search history and saved searches functionality

- [ ] Build AI Performance Metrics Display (AC: 4)
  - [ ] Create AIMetrics component showing automation rate calculations
  - [ ] Implement escalation frequency tracking and visualization
  - [ ] Build confidence score metrics with trend analysis
  - [ ] Create response time analytics with Arabic conversation awareness
  - [ ] Add AI effectiveness scoring dashboard
  - [ ] Implement performance comparison charts over time periods

- [ ] Implement Data Export Functionality (AC: 7)
  - [ ] Create ReportGenerator component with CSV export capability
  - [ ] Build export configuration panel for date ranges and filters
  - [ ] Implement feedback data export with Arabic text encoding (UTF-8)
  - [ ] Create scheduled export functionality with email delivery
  - [ ] Add export history and download management
  - [ ] Implement data formatting for Excel compatibility

- [ ] Create Configuration Management Panel (AC: 8)
  - [ ] Build SettingsPanel component for operating hours configuration
  - [ ] Create PersonalityConfig component for AI personality template selection
  - [ ] Implement EscalationRules component for alert threshold management
  - [ ] Add prayer time settings with Saudi cities integration
  - [ ] Create branch-specific configuration overrides
  - [ ] Build settings validation and preview functionality

- [ ] Set Up API Integration Layer (All ACs)
  - [ ] Configure API client with Supabase auth token interceptors
  - [ ] Create service layer for conversation data fetching
  - [ ] Implement analytics data service with caching support
  - [ ] Build export service with progress tracking
  - [ ] Set up error handling with Arabic-friendly error messages
  - [ ] Create retry logic for failed API calls

- [ ] Implement Frontend Testing Infrastructure (All ACs)
  - [ ] Create component unit tests using Vitest and React Testing Library
  - [ ] Build integration tests for Supabase Realtime functionality
  - [ ] Implement E2E tests using Playwright for critical workflows
  - [ ] Test Arabic/English language switching functionality
  - [ ] Create mobile responsiveness tests for primary use case
  - [ ] Add accessibility tests for WCAG AA compliance

- [ ] Mobile Optimization and PWA Setup (AC: 5)
  - [ ] Configure Next.js PWA for mobile app-like experience
  - [ ] Implement touch-friendly interface components
  - [ ] Optimize loading performance for mobile networks
  - [ ] Create offline functionality for conversation viewing
  - [ ] Add mobile-specific navigation patterns
  - [ ] Test cross-device synchronization

## Dev Notes

### Previous Story Insights
[Source: Story 1.4 Completion Notes]
- Analytics service fully operational with comprehensive feedback aggregation
- Supabase Realtime integration established for real-time updates
- Campaign management and A/B testing framework available for data export
- Arabic conversation processing with sentiment analysis proven functional
- WebSocket notification system ready for dashboard integration
- CSV export functionality patterns established and tested

### Tech Stack Configuration
[Source: architecture/tech-stack.md]

**Core Technologies Required:**
- Next.js 14.2+ with App Router for dashboard frontend
- TypeScript 5.3+ for type-safe React development
- Shadcn/ui + Tailwind CSS 3.4+ with RTL Arabic support
- Zustand 4.5+ for lightweight state management
- Supabase Realtime for WebSocket connections
- Vitest + React Testing Library for testing
- Recharts/Tremor for analytics visualization
- React-pdf for export functionality

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]

**Dashboard App Structure:**
```
apps/dashboard/
├── src/
│   ├── app/                    # Next.js 14 App Router
│   │   ├── (auth)/             # Auth-required pages
│   │   │   ├── dashboard/      # Main dashboard route
│   │   │   ├── conversations/  # Conversation monitor
│   │   │   ├── analytics/      # Analytics dashboard
│   │   │   └── settings/       # Configuration panel
│   │   ├── layout.tsx          # Root layout with providers
│   │   └── globals.css         # Global styles with Tailwind
│   ├── components/
│   │   ├── ui/                 # Shadcn/ui components
│   │   ├── dashboard/          # Dashboard-specific components
│   │   ├── conversations/      # Conversation components
│   │   ├── analytics/          # Chart components
│   │   └── shared/             # Shared components
│   ├── hooks/                  # Custom React hooks
│   ├── lib/                    # Utilities and configs
│   ├── stores/                 # Zustand stores
│   └── types/                  # TypeScript types
```

### Data Models and API Integration
[Source: architecture/data-models.md, api-specification.md]

**Key Data Models for Dashboard:**
```typescript
// Global state structure for Zustand
interface AppState {
  // Restaurant context
  restaurant: Restaurant | null;
  selectedBranch: Branch | null;
  branches: Branch[];
  
  // Conversations state
  conversations: {
    items: Conversation[];
    activeId: string | null;
    filters: ConversationFilters;
    isLoading: boolean;
  };
  
  // Real-time metrics
  metrics: {
    dashboard: DashboardMetrics;
    lastUpdated: string;
  };
  
  // UI state
  ui: {
    sidebarOpen: boolean;
    theme: 'light' | 'dark' | 'system';
    language: 'ar' | 'en';
  };
}

// Conversation model for real-time display
interface Conversation {
  id: string;
  customerId: string;
  restaurantId: string;
  branchId?: string;
  status: 'active' | 'escalated' | 'resolved' | 'abandoned';
  type: 'feedback' | 'order' | 'support' | 'general';
  aiConfidence: number;
  messages: Message[];
  startedAt: string;
  escalatedAt?: string;
  resolvedAt?: string;
}

// Feedback model for analytics
interface Feedback {
  id: string;
  conversationId: string;
  customerId: string;
  branchId: string;
  rating: 1 | 2 | 3 | 4 | 5;
  comment?: string;
  sentiment: 'positive' | 'neutral' | 'negative';
  categories: string[];
  requiresFollowup: boolean;
  createdAt: string;
}
```

**Required API Endpoints:**
```
GET    /conversations              # List conversations with filters
GET    /conversations/{id}         # Get conversation details
POST   /conversations/{id}/messages # Send manual intervention message
GET    /analytics/dashboard        # Dashboard metrics
GET    /analytics/feedback         # Feedback analytics
GET    /settings/restaurant        # Restaurant configuration
PUT    /settings/restaurant        # Update restaurant settings
POST   /export/feedback            # Export feedback data to CSV
```

### Supabase Realtime Integration
[Source: architecture/api-specification.md]

**WebSocket Event Subscriptions:**
```typescript
// Realtime subscription setup for dashboard
const channel = supabase
  .channel('restaurant_updates')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'conversations',
    filter: `restaurant_id=eq.${restaurantId}`
  }, handleNewConversation)
  .on('postgres_changes', {
    event: 'UPDATE',
    schema: 'public',
    table: 'conversations',
    filter: `restaurant_id=eq.${restaurantId}`
  }, handleConversationUpdate)
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'feedback',
    filter: `restaurant_id=eq.${restaurantId}`
  }, handleNewFeedback)
  .subscribe();

// Key realtime events to handle
interface RealtimeEvents {
  'conversation:new': { conversation: Conversation; customer: Customer };
  'conversation:status': { conversationId: string; oldStatus: string; newStatus: string };
  'message:new': { conversationId: string; message: Message };
  'ai:low_confidence': { conversationId: string; confidence: number };
  'feedback:negative': { feedback: Feedback; requiresFollowup: boolean };
}
```

### Component Architecture
[Source: architecture/components.md, frontend-architecture.md]

**Frontend Component Organization:**
- **Dashboard Shell**: Main layout with auth, navigation, and notification center
- **Conversation Monitor**: Real-time conversation viewing and intervention
- **Analytics Dashboard**: Metrics visualization and reporting
- **Settings Manager**: Configuration panel for restaurant settings

**State Management with Zustand:**
- Centralized store for global restaurant context
- Separate stores for conversations, metrics, and UI state
- Optimistic updates for real-time feel
- Persistence for user preferences and settings

### Arabic/RTL Support Requirements
[Source: architecture/tech-stack.md, coding-standards.md]

**Internationalization Setup:**
- Tailwind CSS with RTL support enabled
- Arabic font loading (IBM Plex Sans Arabic or similar)
- Bidirectional text handling for mixed content
- Number formatting for Arabic numerals
- Date/time formatting for Saudi locale
- Right-to-left navigation and layout components

### Security and Performance Considerations
[Source: architecture/security-and-performance.md]

**Security Requirements:**
- JWT token handling with automatic refresh
- Row Level Security (RLS) enforcement through Supabase
- XSS protection for user-generated Arabic text content
- CSRF protection for state-changing operations
- Secure WebSocket connections with authentication

**Performance Optimization:**
- Component lazy loading for dashboard sections
- Conversation list virtualization for large datasets
- Analytics data caching with 30-second TTL
- Image optimization for charts and visualizations
- Mobile-first loading strategies

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Frontend Testing Standards:**
- **Component Tests**: `apps/dashboard/tests/components/`
  - Dashboard components: `Dashboard*.test.tsx`
  - Conversation components: `Conversation*.test.tsx`  
  - Analytics components: `Analytics*.test.tsx`
- **Hook Tests**: `apps/dashboard/tests/hooks/`
  - Custom hooks: `useRealtime*.test.ts`
  - State management: `use*Store.test.ts`
- **Integration Tests**: `apps/dashboard/tests/pages/`
  - Page-level functionality and routing
  - Supabase integration testing
- **E2E Tests**: `apps/dashboard/tests/e2e/`
  - Critical user journeys with Playwright
  - Arabic language switching flows
  - Mobile responsiveness testing

**Testing Frameworks:**
- Vitest for unit and integration tests
- React Testing Library for component testing
- Playwright for E2E browser automation
- Mock Service Worker (MSW) for API mocking

### Error Handling Strategy
[Source: architecture/error-handling-strategy.md]

**Frontend Error Handling:**
- Global error boundary for React component errors
- API error handling with Arabic-friendly messages
- Network error handling with retry mechanisms
- Real-time connection error recovery
- Graceful degradation for offline scenarios

### Testing
[Source: architecture/testing-strategy.md]

**Frontend Testing Standards:**
- **Test File Locations**: `apps/dashboard/tests/`
  - Component Tests: `apps/dashboard/tests/components/Dashboard*.test.tsx`, `Conversation*.test.tsx`, `Analytics*.test.tsx`
  - Hook Tests: `apps/dashboard/tests/hooks/useRealtime*.test.ts`, `use*Store.test.ts`
  - Page Tests: `apps/dashboard/tests/pages/` for routing and integration
  - E2E Tests: `apps/dashboard/tests/e2e/` for critical user journeys

**Testing Frameworks:**
- **Vitest** for unit and integration tests with React Testing Library
- **Playwright** for E2E browser automation and mobile responsiveness
- **Mock Service Worker (MSW)** for API mocking during tests
- **Testing Library** utilities for component testing

**Specific Testing Requirements:**
- Arabic/English language switching flows must be E2E tested
- Mobile responsiveness testing for primary use case (restaurant owners on phones)
- Supabase Realtime integration testing for WebSocket connections
- Real-time conversation monitor functionality testing
- Dashboard metrics accuracy and update frequency testing
- Export functionality testing with Arabic text encoding (UTF-8)
- Accessibility testing for WCAG AA compliance

**Test Standards:**
- Minimum 80% code coverage for components and hooks
- All critical user journeys must have E2E test coverage
- API integration tests using MSW for consistent mocking
- Component tests should focus on user interactions, not implementation details
- Performance testing for mobile loading times and conversation list virtualization

### Integration Points
[Source: Story 1.1, 1.2, 1.3, 1.4 implementations]

**Existing System Integration:**
- WhatsApp Gateway Service for message sending in intervention panel
- AI Processor Service for conversation confidence metrics
- Core API Service for all CRUD operations
- Analytics Service for dashboard metrics and export functionality
- Feedback campaign system for export data sources

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story creation with comprehensive architecture context | Scrum Master (Bob) |
| 2025-09-08 | 1.1 | Added missing Testing section under Dev Notes per template requirements | Product Owner (Sarah) |

## Dev Agent Record

*This section is populated by the development agent during implementation*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

*Results from QA Agent QA review of the completed story implementation*